# Event Definition Guide\n\nEvents are immutable facts recorded in the append-only log. Define them carefully - they're the foundation of state reconstruction.\n\n## Event Anatomy\n\n```python\nfrom dataclasses import dataclass\nfrom datetime import datetime\n\n@dataclass(frozen=True)  # CRITICAL: frozen=True makes event immutable\nclass MyEvent(GameEvent):\n    \"\"\"\n    Describes a fact that happened: [agent] did [action] with [result].\n    Example: Agent PLAYER_001 took a loan of $5000 at 5% interest.\n    \"\"\"\n    # Required fields (inherited from GameEvent, don't repeat)\n    # - event_id: str\n    # - event_type: str\n    # - agent_id: str\n    # - timestamp: datetime\n    # - week: int\n    \n    # Event-specific fields (REQUIRED, no defaults)\n    loan_id: str\n    principal: float\n    interest_rate: float\n    term_weeks: int\n    \n    # Event-specific fields (OPTIONAL, with defaults)\n    event_type: str = \"MyEvent\"\n    description: str = \"\"\n```\n\n## Field Ordering (Critical for Python 3.14+)\n\nWhen a frozen dataclass inherits from another, **all required fields must come before optional fields**:\n\n**✅ CORRECT:**\n```python\n@dataclass(frozen=True)\nclass LoanTaken(GameEvent):\n    # Required fields (no defaults) FIRST\n    loan_id: str\n    principal: float\n    interest_rate: float\n    term_weeks: int\n    \n    # Optional fields (with defaults) LAST\n    event_type: str = \"LoanTaken\"\n```\n\n**❌ WRONG:**\n```python\n@dataclass(frozen=True)\nclass LoanTaken(GameEvent):\n    event_type: str = \"LoanTaken\"  # ❌ Has default\n    loan_id: str  # ❌ ERROR: Required field after optional\n```\n\n## Required Fields from GameEvent Base\n\nAll events inherit these fields from `GameEvent` - never redefine them:\n\n| Field | Type | Set By | Purpose |\n|-------|------|--------|----------|\n| `event_id` | str | Handler (uuid.uuid4()) | Unique event identifier |\n| `event_type` | str | Event class (as default) | Event type name (for lookup) |\n| `agent_id` | str | Handler (from command) | Which agent this affects |\n| `timestamp` | datetime | Handler (datetime.now()) | When event occurred |\n| `week` | int | Handler (from state) | Game week number |\n\n**Example of correct initialization in handler:**\n```python\nevent = LoanTaken(\n    event_id=str(uuid.uuid4()),      # Required\n    event_type=\"LoanTaken\",          # Optional (has default)\n    agent_id=state.agent_id,         # Required\n    timestamp=datetime.now(),        # Required\n    week=state.current_week,         # Required\n    loan_id=loan_id,                 # Event-specific required\n    principal=principal,             # Event-specific required\n    interest_rate=interest_rate,     # Event-specific required\n    term_weeks=term_weeks,           # Event-specific required\n)\n```\n\n## Event Naming Convention\n\nEvent names should describe **what happened** (past tense):\n\n| ❌ Wrong | ✅ Correct | Reason |\n|---------|-----------|--------|\n| `TakeALoan` | `LoanTaken` | Events are facts, not commands |\n| `PriceChanging` | `PriceSet` | Events are complete, not in-progress |\n| `TransferFunds` | `FundsTransferred` | Past tense, fact-based |\n| `UpdateScore` | `SocialScoreAdjusted` | Specific action, not generic |\n\n## Common Event Patterns\n\n### Pattern 1: Simple State Change\n```python\n@dataclass(frozen=True)\nclass SocialScoreAdjusted(GameEvent):\n    \"\"\"\n    Agent's social score changed by a delta amount.\n    Caused by: charity actions, scandals, ethical choices, etc.\n    \"\"\"\n    adjustment: float  # Can be positive or negative\n    reason: str = \"\"   # Why it changed\n    event_type: str = \"SocialScoreAdjusted\"\n```\n\n### Pattern 2: Financial Transaction\n```python\n@dataclass(frozen=True)\nclass FundsTransferred(GameEvent):\n    \"\"\"\n    Money moved in or out of agent's account.\n    Required for cash balance updates.\n    \"\"\"\n    amount: float  # Positive for credit, negative for debit\n    transaction_type: str  # \"REVENUE\", \"EXPENSE\", \"LOAN\", \"PAYMENT\"\n    description: str\n    event_type: str = \"FundsTransferred\"\n```\n\n### Pattern 3: Resource Acquired\n```python\n@dataclass(frozen=True)\nclass SuppliesAcquired(GameEvent):\n    \"\"\"\n    Agent purchased supplies (detergent, etc.).\n    \"\"\"\n    quantity: int  # Units acquired\n    supply_type: str  # \"detergent\", \"softener\", etc.\n    cost: float  # Total payment\n    supplier_id: str = \"\"  # Which vendor supplied it\n    event_type: str = \"SuppliesAcquired\"\n```\n\n### Pattern 4: Complex Multi-Field Change\n```python\n@dataclass(frozen=True)\nclass EmployeeHired(GameEvent):\n    \"\"\"\n    Agent hired a new staff member.\n    All hiring details recorded for recruitment history.\n    \"\"\"\n    location_id: str\n    staff_id: str\n    staff_name: str\n    role: str  # \"Manager\", \"Attendant\", \"Cleaner\"\n    hourly_rate: float\n    benefits: tuple = ()  # Tuple because frozen - can't mutate lists\n    event_type: str = \"EmployeeHired\"\n```\n\n## Collection Fields in Events\n\nFrozen dataclasses can't contain mutable lists/dicts as defaults. Use tuples or `field(default_factory=tuple)`:\n\n**❌ WRONG - list is mutable:**\n```python\n@dataclass(frozen=True)\nclass MyEvent(GameEvent):\n    items: list = []  # ERROR: default is mutable\n```\n\n**✅ CORRECT - use tuple:**\n```python\n@dataclass(frozen=True)\nclass MyEvent(GameEvent):\n    items: tuple = ()  # Immutable tuple\n```\n\n**✅ CORRECT - use field(default_factory=tuple):**\n```python\nfrom dataclasses import field\n\n@dataclass(frozen=True)\nclass MyEvent(GameEvent):\n    items: tuple = field(default_factory=tuple)\n```\n\n## Event Details for LLM Evaluation\n\nInclude sufficient context in events for LLMs to reason about situations:\n\n**❌ SPARSE (insufficient):**\n```python\n@dataclass(frozen=True)\nclass DilemmaTriggered(GameEvent):\n    dilemma_id: str\n    event_type: str = \"DilemmaTriggered\"\n    # LLM has no idea what the dilemma IS\n```\n\n**✅ RICH (actionable):**\n```python\n@dataclass(frozen=True)\nclass DilemmaTriggered(GameEvent):\n    dilemma_id: str\n    title: str  # \"Hiring Underpaid Staff\"\n    description: str  # Full problem statement\n    options: tuple  # (\"Hire them\", \"Refuse\", \"Negotiate\")\n    ethical_impact: dict  # {option: impact_description}\n    financial_impact: dict  # {option: cost/savings}\n    deadline_week: int  # When decision must be made\n    event_type: str = \"DilemmaTriggered\"\n```\n\n## Registration\n\nAfter defining a new event, register a projection handler in `projection/handlers/core_handlers.py`:\n\n```python\n# projection/handlers/core_handlers.py\n\ndef handle_my_new_event(state: AgentState, event: MyNewEvent) -> AgentState:\n    new_state = deepcopy(state)\n    new_state.some_field = event.some_value\n    return new_state\n\nCORE_EVENT_HANDLERS = {\n    \"TimeAdvanced\": handle_time_advanced,\n    \"FundsTransferred\": handle_funds_transferred,\n    # ... existing handlers ...\n    \"MyNewEvent\": handle_my_new_event,  # Add here\n}\n```\n\n## Testing Event Creation\n\n```python\nfrom core.events import LoanTaken\nfrom datetime import datetime\nimport uuid\n\n# Create event\nevent = LoanTaken(\n    event_id=str(uuid.uuid4()),\n    event_type=\"LoanTaken\",\n    agent_id=\"PLAYER_001\",\n    timestamp=datetime.now(),\n    week=5,\n    loan_id=\"LOAN_123\",\n    principal=5000.0,\n    interest_rate=0.05,\n    term_weeks=26,\n)\n\n# Verify immutability\nassert isinstance(event, LoanTaken)\nevent.principal = 6000.0  # ❌ Will raise FrozenInstanceError\n```\n\n## Event Schema Example\n\n```python\n# Complete financial event showing all patterns\nfrom dataclasses import dataclass\nfrom core.events import GameEvent\nfrom datetime import datetime\n\n@dataclass(frozen=True)\nclass LoanTaken(GameEvent):\n    \"\"\"\n    Agent obtained a loan.\n    \n    Emitted by: TakeLoanHandler\n    Projected by: handle_loan_taken\n    Resulting state change: total_debt_owed += principal\n    \"\"\"\n    # Event-specific required fields\n    loan_id: str\n    principal: float\n    interest_rate: float\n    term_weeks: int\n    \n    # Event-specific optional fields\n    lender_id: str = \"BANK\"  # Default to system bank\n    event_type: str = \"LoanTaken\"\n```\n\nThis event fully describes a loan transaction - when applied to state by the projection handler, cash_balance increases by principal, total_debt_owed increases by principal, and a loan record is created for tracking payments.\n
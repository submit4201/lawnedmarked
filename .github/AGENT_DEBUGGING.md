# Debugging Guide\n\n## Diagnosis Workflow\n\nWhen something goes wrong, follow this systematic approach:\n\n### 1. Identify the Failure Type\n\n**Is it a code crash?**\n→ Check Python error traceback\n→ Common: TypeError (field ordering), NameError (missing import), AttributeError (missing field)\n\n**Is it a validation error?**\n→ Check GameEngine.execute_command() returns `(success=False, events=[], message)`\n→ Message explains why (e.g., \"Validation failed: ...\")\n\n**Is it a state reconstruction issue?**\n→ Command succeeded but state didn't update as expected\n→ Check event log was persisted\n→ Check projection handler applied event correctly\n\n### 2. Check the Event Log\n\n```python\n# In test file or interactive debugger\nfrom application_factory import ApplicationFactory\n\nengine, _, _ = ApplicationFactory.create_game_engine()\n\n# Get complete event history\nevents = engine.get_event_log(\"PLAYER_001\")\n\nprint(f\"Total events: {len(events)}\")\nfor i, event in enumerate(events, 1):\n    print(f\"{i}. {event.event_type}\")\n    print(f\"   ID: {event.event_id}\")\n    print(f\"   Week: {event.week}\")\n    if hasattr(event, 'amount'):  # Financial events\n        print(f\"   Amount: {event.amount}\")\n    print()\n```\n\nThe event log is the **source of truth**. If your event isn't here, it wasn't saved.\n\n### 3. Check State Reconstruction\n\n```python\n# Get current state\nstate = engine.get_current_state(\"PLAYER_001\")\n\n# Verify critical fields\nprint(f\"Agent ID: {state.agent_id}\")\nprint(f\"Cash: ${state.cash_balance:.2f}\")\nprint(f\"Debt: ${state.total_debt_owed:.2f}\")\nprint(f\"Current Week: {state.current_week}\")\nprint(f\"Locations: {len(state.locations)}\")\nprint(f\"Social Score: {state.social_score}\")\n```\n\nState should reflect all persisted events applied in order.\n\n## Common Issues and Fixes\n\n### Issue: TypeError: non-default argument X follows default argument Y\n\n**Where it happens:**\nWhen defining a frozen dataclass that inherits from GameEvent\n\n**Why it happens:**\nPython 3.14+ requires: all fields without defaults come before fields with defaults\n\n**Example failure:**\n```python\n@dataclass(frozen=True)\nclass LoanTaken(GameEvent):\n    event_type: str = \"LoanTaken\"  # ❌ Has default\n    loan_id: str  # ❌ ERROR: No default but comes after\n```\n\n**Fix:**\nReorder fields - required first, optional last:\n```python\n@dataclass(frozen=True)\nclass LoanTaken(GameEvent):\n    loan_id: str  # ✅ No default\n    principal: float  # ✅ No default\n    event_type: str = \"LoanTaken\"  # ✅ Has default\n```\n\n### Issue: NameError: handler not defined\n\n**Where it happens:**\nWhen executing a command that isn't registered\n\n**Why it happens:**\nHandler not exported in `command_handlers/__init__.py`\n\n**Debug:**\n```python\nfrom command_handlers import ALL_HANDLERS\nprint(\"Registered commands:\", list(ALL_HANDLERS.keys()))\nprint(\"Looking for: TAKE_LOAN in ALL_HANDLERS?\", \"TAKE_LOAN\" in ALL_HANDLERS)\n```\n\n**Fix:**\nEnsure handler is in `ALL_HANDLERS` dict:\n```python\n# command_handlers/__init__.py\nfrom .financial_handlers import TakeLoanHandler\n\nALL_HANDLERS = {\n    \"TAKE_LOAN\": TakeLoanHandler(),  # ✅ Add this line\n}\n```\n\n### Issue: Agent ID mismatch\n\n**Where it happens:**\nGameEngine.execute_command() returns (False, [], \"Agent ID mismatch\")\n\n**Why it happens:**\nState doesn't have agent_id set, or it doesn't match the command's agent_id\n\n**Debug:**\n```python\nstate = engine.get_current_state(\"PLAYER_001\")\nprint(f\"State agent_id: '{state.agent_id}'\")\nprint(f\"Expected: 'PLAYER_001'\")\nprint(f\"Match? {state.agent_id == 'PLAYER_001'}\")\n```\n\n**Fix:**\nEnsure StateBuilder sets agent_id:\n```python\n# In game_engine.py get_current_state()\nreturn self.state_builder.build_state(agent_events, agent_id=agent_id)\n```\n\n### Issue: Command executed but no events generated\n\n**Where it happens:**\nGameEngine.execute_command() returns (False, [], \"Validation failed: ...\")\n\n**Why it happens:**\nHandler raised a DomainException (validation failure)\n\n**Debug:**\n```python\ncommand = SetPriceCommand(\n    agent_id=\"PLAYER_001\",\n    payload={\"location_id\": \"LOC_INVALID\", \"service_type\": \"Wash\", \"new_price\": 3.50}\n)\n\nsuccess, events, message = engine.execute_command(\"PLAYER_001\", command)\n\nif not success:\n    print(f\"Failed: {message}\")  # Will show: \"Validation failed: Location LOC_INVALID not found\"\n```\n\n**Fix:**\nVerify preconditions before command:\n```python\n# Check location exists\nif \"LOC_001\" not in state.locations:\n    print(\"Location doesn't exist - create it first\")\n    # ... execute BUY_EQUIPMENT or OPEN_NEW_LOCATION first\n```\n\n### Issue: State field not updating after command\n\n**Example:** Execute TAKE_LOAN, but cash_balance doesn't increase\n\n**Debug systematically:**\n\n```python\n# Step 1: Check event was generated\ncommand = TakeLoanCommand(agent_id=\"P1\", payload={\"principal\": 5000, ...})\nsuccess, events, message = engine.execute_command(\"P1\", command)\n\nprint(f\"Success: {success}\")\nprint(f\"Events: {len(events)}\")\nfor e in events:\n    print(f\"  - {e.event_type}\")\n\n# Step 2: Check event persisted\nall_events = engine.get_event_log(\"P1\")\nprint(f\"\\nEvents in log: {len(all_events)}\")\nfor e in all_events:\n    print(f\"  - {e.event_type}\")\n\n# Step 3: Check state reconstruction\nstate = engine.get_current_state(\"P1\")\nprint(f\"\\nCash balance: {state.cash_balance}\")\nprint(f\"Expected: 15000 (10000 initial + 5000 loan)\")\n```\n\n**If event persisted but state wrong:**\nProjection handler didn't apply it correctly\n\n```python\n# Check the projection handler\nfrom projection.handlers.core_handlers import handle_funds_transferred\nfrom core.events import FundsTransferred\n\ninitial_state = AgentState(agent_id=\"P1\", cash_balance=10000)\nevent = FundsTransferred(\n    event_id=\"e1\",\n    event_type=\"FundsTransferred\",\n    agent_id=\"P1\",\n    timestamp=datetime.now(),\n    week=0,\n    amount=5000,\n    transaction_type=\"LOAN\",\n    description=\"Test loan\",\n)\n\nnew_state = handle_funds_transferred(initial_state, event)\nprint(f\"Initial: {initial_state.cash_balance}\")\nprint(f\"After: {new_state.cash_balance}\")\nprint(f\"Expected: 15000\")\n```\n\n## Debugging Tools\n\n### Print Full State\n\n```python\nimport json\nfrom dataclasses import asdict\n\nstate = engine.get_current_state(\"PLAYER_001\")\nstate_dict = asdict(state)\n\nprint(json.dumps(state_dict, indent=2, default=str))\n```\n\n### Trace Event Application\n\n```python\nfrom projection.state_builder import StateBuilder\nfrom infrastructure.event_registry import EventRegistry\nfrom core.models import AgentState\n\nstate_builder = StateBuilder(event_registry, AgentState(agent_id=\"P1\"))\nevents = engine.get_event_log(\"P1\")\n\n# Apply one by one with visibility\ncurrent_state = AgentState(agent_id=\"P1\")\nfor i, event in enumerate(events):\n    print(f\"\\nApplying event {i+1}: {event.event_type}\")\n    print(f\"  Before: cash={current_state.cash_balance}, debt={current_state.total_debt_owed}\")\n    \n    current_state = event_registry.apply(current_state, event)\n    \n    print(f\"  After: cash={current_state.cash_balance}, debt={current_state.total_debt_owed}\")\n```\n\n### Validate Handler Signature\n\n```python\nimport inspect\nfrom command_handlers.financial_handlers import SetPriceHandler\n\nhandler = SetPriceHandler()\nsig = inspect.signature(handler.handle)\n\nprint(f\"Handler signature: {sig}\")\nprint(f\"Parameters: {list(sig.parameters.keys())}\")\n# Expected: ['self', 'state', 'command']\n```\n\n## Testing in Isolation\n\n```python\n# Test a handler without GameEngine\nfrom core.commands import SetPriceCommand\nfrom command_handlers.financial_handlers import SetPriceHandler\nfrom core.models import AgentState, LocationState\n\n# Setup state\nstate = AgentState(agent_id=\"P1\", current_week=0, cash_balance=10000)\nstate.locations[\"LOC_001\"] = LocationState(\n    location_id=\"LOC_001\",\n    zone=\"ZONE_A\",\n    monthly_rent=2000,\n)\n\n# Create command\ncommand = SetPriceCommand(\n    agent_id=\"P1\",\n    payload={\n        \"location_id\": \"LOC_001\",\n        \"service_type\": \"StandardWash\",\n        \"new_price\": 4.50,\n    },\n)\n\n# Execute handler directly\nhandler = SetPriceHandler()\ntry:\n    events = handler.handle(state, command)\n    print(f\"Success! Events: {len(events)}\")\n    for e in events:\n        print(f\"  - {e.event_type}\")\nexcept Exception as e:\n    print(f\"Failed: {e}\")\n```\n\n## Checklist Before Submitting\n\n✅ Does `python main.py` run without crashing?\n✅ Do new commands show up in the registry output?\n✅ Does event log contain all expected events?\n✅ Does state reflect events correctly?\n✅ Are handlers exported in `__init__.py`?\n✅ Are events registered in CORE_EVENT_HANDLERS?\n✅ Are dataclass fields ordered correctly (required before optional)?\n✅ Are all frozen dataclasses marked `frozen=True`?\n
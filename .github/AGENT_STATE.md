# State Model Development Guide\n\nWhen modifying state models, understand their role: **AgentState, LocationState, and GameState are the output \"read models\" that projection handlers are authorized to mutate.**\n\n## State Model Hierarchy\n\n### AgentState (Player/Agent Identity)\n\n**File:** `backend/core/models.py`\n\n```python\n@dataclass\nclass AgentState:\n    # Identity\n    agent_id: str\n    \n    # Time\n    current_week: int = 0\n    \n    # Finance\n    cash_balance: float = 10000.0\n    line_of_credit_balance: float = 0.0\n    total_debt_owed: float = 0.0\n    \n    # Society\n    social_score: float = 50.0\n    active_scandals: List[ScandalMarker] = field(default_factory=list)\n    \n    # Regulation\n    regulatory_status: RegulatoryStatus = RegulatoryStatus.NORMAL\n    pending_fines: List[Fine] = field(default_factory=list)\n    \n    # Operations\n    locations: Dict[str, LocationState] = field(default_factory=dict)\n```\n\n**Projection handlers mutate AgentState fields** when applying events:\n\n```python\ndef handle_funds_transferred(state: AgentState, event: FundsTransferred) -> AgentState:\n    new_state = deepcopy(state)\n    new_state.cash_balance += event.amount  # ✅ Direct mutation (correct in projector)\n    return new_state\n```\n\n### LocationState (Physical Assets)\n\n**File:** `backend/core/models.py`\n\n```python\n@dataclass\nclass LocationState:\n    location_id: str\n    zone: str\n    monthly_rent: float\n    \n    # Cleanliness (0-100)\n    current_cleanliness: float = 80.0\n    \n    # Equipment\n    equipment: Dict[str, MachineState] = field(default_factory=dict)\n    \n    # Supplies (load units)\n    inventory_detergent: int = 1000\n    inventory_softener: int = 500\n    \n    # Staff\n    current_staff: List[StaffMember] = field(default_factory=list)\n    \n    # Pricing by service\n    active_pricing: Dict[str, float] = field(default_factory=lambda: {\n        \"StandardWash\": 3.50,\n        \"PremiumWash\": 5.00,\n        \"Dry\": 2.00,\n    })\n    \n    # Vendors\n    vendor_relationships: Dict[str, VendorRelationship] = field(default_factory=dict)\n    \n    # Weekly tracking\n    accumulated_revenue_week: float = 0.0\n    accumulated_cogs_week: float = 0.0\n```\n\n**Usage:** AgentState.locations contains these by location_id:\n\n```python\nstate.locations[\"LOC_001\"].active_pricing[\"StandardWash\"] = 4.50\n```\n\n### GameState (Multi-Agent)\n\n**File:** `backend/core/models.py`\n\n```python\n@dataclass\nclass GameState:\n    agent: AgentState  # The player (primary focus)\n    agents: Dict[str, AgentState] = field(default_factory=dict)  # All NPCs + player\n```\n\nNot widely used yet - primarily for future multi-agent simulation.\n\n## Supporting Models\n\n### MachineState\n\n```python\n@dataclass\nclass MachineState:\n    machine_id: str\n    type: MachineType  # StandardWasher, Dryer, etc.\n    condition: float = 100.0  # 0-100\n    status: MachineStatus = MachineStatus.OPERATIONAL\n    last_maintenance_week: int = 0\n    loads_processed_since_service: int = 0\n```\n\n**Projection example:**\n\n```python\ndef handle_machine_maintained(state: AgentState, event: MachineMaintained) -> AgentState:\n    new_state = deepcopy(state)\n    for location in new_state.locations.values():\n        if event.machine_id in location.equipment:\n            machine = location.equipment[event.machine_id]\n            machine.condition = 100.0  # Restore to full condition\n            machine.status = MachineStatus.OPERATIONAL\n            machine.last_maintenance_week = state.current_week\n    return new_state\n```\n\n### ScandalMarker\n\n```python\n@dataclass\nclass ScandalMarker:\n    scandal_id: str\n    description: str\n    severity: float  # 0.0-1.0\n    duration_weeks: int  # How long scandal lasts\n    decay_rate: float  # Severity reduction per week\n    start_week: int  # When it started\n```\n\n**Projection example:**\n\n```python\ndef handle_scandal_started(state: AgentState, event: ScandalStarted) -> AgentState:\n    new_state = deepcopy(state)\n    scandal = ScandalMarker(\n        scandal_id=event.scandal_id,\n        description=event.description,\n        severity=event.severity,\n        duration_weeks=event.duration_weeks,\n        decay_rate=0.1,\n        start_week=state.current_week,\n    )\n    new_state.active_scandals.append(scandal)\n    return new_state\n```\n\n### Enums\n\n**MachineStatus:**\n```python\nclass MachineStatus(Enum):\n    OPERATIONAL = \"OPERATIONAL\"\n    BROKEN = \"BROKEN\"\n    IN_REPAIR = \"IN_REPAIR\"\n```\n\n**RegulatoryStatus:**\n```python\nclass RegulatoryStatus(Enum):\n    NORMAL = \"NORMAL\"\n    MONITORING = \"MONITORING\"\n    WARNING = \"WARNING\"\n    INVESTIGATION = \"INVESTIGATION\"\n```\n\n**MachineType:**\n```python\nclass MachineType(Enum):\n    STANDARD_WASHER = \"StandardWasher\"\n    INDUSTRIAL_WASHER = \"IndustrialWasher\"\n    DELUXE_WASHER = \"DeluxeWasher\"\n    DRYER = \"Dryer\"\n    VENDING_MACHINE = \"VendingMachine\"\n```\n\n## Modifying State Models\n\n### When to Add a New Field\n\nAdd to state if it:\n1. Represents a fact that must persist across game sessions\n2. Is updated by events (not computed on-the-fly)\n3. Is needed for validation in command handlers\n\n**Example: Adding credit_rating to AgentState**\n\n```python\n# Step 1: Add field to model\n@dataclass\nclass AgentState:\n    # ... existing fields ...\n    credit_rating: int = 50  # 1-100\n\n# Step 2: Create event for changes\n@dataclass(frozen=True)\nclass CreditRatingAdjusted(GameEvent):\n    adjustment: int  # +5, -10, etc.\n    reason: str = \"\"\n    new_rating: int = 0\n    event_type: str = \"CreditRatingAdjusted\"\n\n# Step 3: Create projection handler\ndef handle_credit_rating_adjusted(state: AgentState, event: CreditRatingAdjusted) -> AgentState:\n    new_state = deepcopy(state)\n    new_state.credit_rating = event.new_rating\n    return new_state\n\n# Step 4: Register handler\nCORE_EVENT_HANDLERS = {\n    # ...\n    \"CreditRatingAdjusted\": handle_credit_rating_adjusted,\n}\n\n# Step 5: Use in validation\nclass TakeLoanHandler(CommandHandler):\n    def handle(self, state: AgentState, command: TakeLoanCommand) -> List[GameEvent]:\n        if state.credit_rating < 30:  # ✅ Now can validate\n            raise CreditError(\"Credit too low\")\n        # ...\n```\n\n### Field Naming Conventions\n\n| Pattern | Example | Purpose |\n|---------|---------|----------|\n| `current_*` | `current_week`, `current_cleanliness` | Live value that changes |\n| `accumulated_*` | `accumulated_revenue_week` | Sum/total over period |\n| `active_*` | `active_scandals`, `active_pricing` | Current list/dict |\n| `total_*` | `total_debt_owed` | Overall aggregate |\n| `*_rating` | `credit_rating` | Score or rating (int) |\n| `*_score` | `social_score` | Score or rating (float) |\n| `*_status` | `regulatory_status` | Current state (Enum) |\n\n### Default Values\n\nChoose defaults that represent \"new agent starting\":\n\n```python\n@dataclass\nclass AgentState:\n    cash_balance: float = 10000.0  # Starting cash\n    social_score: float = 50.0  # Neutral reputation\n    credit_rating: int = 50  # Average credit\n    current_week: int = 0  # Game start\n    locations: Dict[str, LocationState] = field(default_factory=dict)  # No locations yet\n```\n\n## Immutability Semantics\n\nWhile AgentState is **technically mutable** (Python dataclass without frozen=True), treat it as **semantically immutable** in command handlers:\n\n✅ **Correct** (handlers don't mutate state):\n```python\ndef handle(self, state: AgentState, command: Command) -> List[GameEvent]:\n    # Read state immutably\n    if state.cash_balance > 1000:\n        # Emit event based on state\n        return [MyEvent(...)]\n    return []  # Don't mutate state\n```\n\n❌ **Wrong** (handlers mutate state):\n```python\ndef handle(self, state: AgentState, command: Command) -> List[GameEvent]:\n    state.cash_balance -= 100  # ❌ NEVER DO THIS\n    return [MyEvent(...)]\n```\n\nOnly projection handlers mutate state:\n```python\ndef handle_funds_transferred(state: AgentState, event: FundsTransferred) -> AgentState:\n    new_state = deepcopy(state)  # Copy for safety\n    new_state.cash_balance += event.amount  # ✅ Mutate copy, not input\n    return new_state\n```\n\n## Testing State Models\n\n```python\nfrom core.models import AgentState, LocationState, MachineState, MachineType\n\n# Create initial state\nstate = AgentState(agent_id=\"TEST_001\")\n\n# Add location\nstate.locations[\"LOC_001\"] = LocationState(\n    location_id=\"LOC_001\",\n    zone=\"DOWNTOWN\",\n    monthly_rent=2000.0,\n)\n\n# Add machine to location\nstate.locations[\"LOC_001\"].equipment[\"WASH_01\"] = MachineState(\n    machine_id=\"WASH_01\",\n    type=MachineType.STANDARD_WASHER,\n)\n\n# Verify\nassert state.locations[\"LOC_001\"].equipment[\"WASH_01\"].type == MachineType.STANDARD_WASHER\n```\n"